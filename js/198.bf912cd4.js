"use strict";(globalThis["webpackChunkastral"]=globalThis["webpackChunkastral"]||[]).push([[198],{73198:(e,s,t)=>{t.r(s),t.d(s,{default:()=>B});t(40702);var a=t(59835),r=t(86970),i=t(61957);const l=e=>((0,a.dD)("data-v-ad383cf6"),e=e(),(0,a.Cn)(),e),n=l((()=>(0,a._)("div",{id:"header-placeholder"},null,-1))),o={id:"header",ref:"header"},u={class:"flex row justify-evenly no-wrap full-width q-pt-sm q-px-sm"},d={class:"relative-position"},p={class:"absolute-top flex justify-center"},c={class:"text-accent z-top q-px-sm",style:{},id:"current-datestamp"},h={key:0,class:"row justify-center q-my-md"},m=l((()=>(0,a._)("div",{style:{height:".5rem"}},null,-1))),g={class:"full-width relative-position q-pt-xs"},y={class:"gt-xs"};function k(e,s,t,l,k,b){const v=(0,a.up)("BaseUserCard"),f=(0,a.up)("q-separator"),M=(0,a.up)("BaseMessage"),w=(0,a.up)("q-spinner-orbit"),$=(0,a.up)("q-infinite-scroll"),S=(0,a.up)("q-btn"),x=(0,a.up)("BasePostEntry"),q=(0,a.up)("q-page"),_=(0,a.Q2)("scroll-fire");return(0,a.wg)(),(0,a.j4)(q,{class:"flex column no-wrap",style:{"min-height":"unset"}},{default:(0,a.w5)((()=>[n,(0,a._)("div",o,[(0,a._)("div",u,[e.$route.params.pubkey?((0,a.wg)(),(0,a.j4)(v,{key:0,pubkey:e.$route.params.pubkey,"action-buttons":!1,style:{width:"50%"}},null,8,["pubkey"])):(0,a.kq)("",!0),e.$store.state.keys.pub?((0,a.wg)(),(0,a.j4)(v,{key:1,pubkey:e.$store.state.keys.pub,"action-buttons":!1,"align-right":!0,style:{width:"50%","self-justify":"end"}},null,8,["pubkey"])):(0,a.kq)("",!0)]),(0,a.Wm)(f,{color:"accent",size:"1px",spaced:""}),(0,a._)("div",d,[(0,a._)("div",p,[(0,a._)("span",c,(0,r.zw)(k.currentDatestamp),1)])])],512),(0,a._)("div",{ref:"messageScroll",id:"message-scroll",onScroll:s[0]||(s[0]=(...e)=>b.updateCurrentDatestamp&&b.updateCurrentDatestamp(...e)),onTouchmove:s[1]||(s[1]=(...e)=>b.updateCurrentDatestamp&&b.updateCurrentDatestamp(...e)),onTouchend:s[2]||(s[2]=(...e)=>b.delayedUpdateCurrentDatestamp&&b.delayedUpdateCurrentDatestamp(...e))},[(0,a.Wm)($,{onLoad:b.loadMore,reverse:"",ref:"messagesScroll"},{loading:(0,a.w5)((()=>[k.canLoadMore?((0,a.wg)(),(0,a.iD)("div",h,[(0,a.Wm)(w,{color:"accent",size:"md"})])):(0,a.kq)("",!0)])),default:(0,a.w5)((()=>[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(k.messages,((s,t)=>{var i;return(0,a.wg)(),(0,a.iD)("div",{key:s.id+"_"+(null===(i=s.taggedEvents)||void 0===i?void 0:i.length),class:"flex column items-self"},[0===t||e.dateUTC(k.messages[t].created_at)!==e.dateUTC(k.messages[t-1].created_at)?((0,a.wg)(),(0,a.iD)("div",{key:0,class:(0,r.C_)(["self-center text-accent datestamp",0===t?"q-pb-sm":"q-py-sm"])},(0,r.zw)(e.dateUTC(s.created_at)),3)):(0,a.kq)("",!0),(0,a.wy)((0,a.Wm)(M,{id:s.id,event:s,onMounted:b.scrollToBottom,onReply:b.reply},null,8,["id","event","onMounted","onReply"]),[[_,b.markAsRead]])])})),128)),m])),_:1},8,["onLoad"])],544),(0,a._)("div",g,[k.unreadMessagesSet.size?((0,a.wg)(),(0,a.j4)(S,{key:0,label:k.unreadMessagesSet.size+" unread","icon-right":"mail_lock",color:"secondary",class:"q-ma-sm unread-messages-button",outline:"",size:"sm",onClick:s[3]||(s[3]=(0,i.iM)((e=>b.scrollToBottom()),["stop"]))},null,8,["label"])):(0,a.kq)("",!0),(0,a._)("div",y,[(0,a.Wm)(f,{color:"accent",size:"1px"}),(0,a.Wm)(x,{"message-mode":b.messageMode,event:k.replyEvent,onClearEvent:s[4]||(s[4]=e=>k.replyEvent=null),onSent:s[5]||(s[5]=e=>k.replyEvent=null),class:"q-px-md q-pt-sm"},null,8,["message-mode","event"])])])])),_:1})}t(46727);var b=t(18933),v=t(34136),f=t(3475),M=t(19302);const w={name:"Messages",mixins:[b.Z],emits:["reply-event","scroll-to-rect"],components:{BaseMessage:f.Z},setup(){const e=(0,M.Z)();return e},data(){return{sub:null,messages:[],canLoadMore:!0,text:"",messagesSet:new Set,unreadMessagesSet:new Set,unlock:()=>{},mutex:null,replyEvent:null,currentDatestamp:null}},computed:{messageMode(){return"messages"===this.$route.name?this.replyEvent?"reply":"message":null}},async activated(){await this.start(),this.scrollToBottom(),this.resizeHeaderPlaceholder()},async deactivated(){this.sub&&(this.sub.cancel(),this.sub=null),this.$store.dispatch("cancelUseProfile",{pubkey:this.$route.params.pubkey})},methods:{async lock(){this.mutex&&await this.mutex,this.mutex=new Promise((e=>{this.unlock=e}))},async start(){if(this.sub&&this.sub.cancel(),this.$store.dispatch("useProfile",{pubkey:this.$route.params.pubkey}),this.$store.state.unreadMessages[this.$route.params.pubkey]){let e=await(0,v.Uk)(this.$store.state.keys.pub,this.$route.params.pubkey,this.$store.state.unreadMessages[this.$route.params.pubkey]),s=await this.processMessages(e);this.messages.push(...s)}this.$store.commit("haveReadMessage",this.$route.params.pubkey),this.sub=await(0,v.yt)((async e=>{let s=e.tags.filter((([e,s])=>"p"===e&&s)).map((([e,s])=>s));(e.pubkey===this.$route.params.pubkey&&s.includes(this.$store.state.keys.pub)||e.pubkey===this.$store.state.keys.pub&&s.includes(this.$route.params.pubkey))&&this.addMessage(e)}))},async scrollToBottom(){return new Promise((e=>setTimeout((()=>{this.$refs.messageScroll.scrollTop=this.$refs.messageScroll.scrollHeight,this.$emit("scroll-to-rect",{top:this.$refs.messageScroll.scrollHeight}),this.$store.commit("haveReadMessage",this.$route.params.pubkey),this.unreadMessagesSet.clear(),e()}),100)))},async loadMore(e,s){var t;let a=await(0,v.Uk)(this.$store.state.keys.pub,this.$route.params.pubkey,50,(null===(t=this.messages[0])||void 0===t?void 0:t.created_at)-1||Math.round(Date.now()/1e3));a.length<50&&(this.canLoadMore=!1);let r=await this.processMessages(a);this.messages=r.concat(this.messages),s(!this.canLoadMore)},async processMessages(e){let s=[];for(let t=0;t<e.length;t++){let a=e[t];if(!this.messagesSet.has(a.id)){if(this.messagesSet.add(a.id),a.text=await this.getPlaintext(a),this.interpolateMessageMentions(a),a.appended)for(let e=0;e<a.appended.length;e++)this.messagesSet.add(a.appended[e].id),a.appended[e].text=await this.getPlaintext(a.appended[e]),this.interpolateMessageMentions(a.appended[e]);s.push(a)}}return s},markAsRead(e){0!==this.unreadMessagesSet.size&&this.unreadMessagesSet.has(e.id)&&(this.unreadMessagesSet.delete(e.id),0===this.unreadMessagesSet.size&&this.$store.commit("haveReadMessage",this.$route.params.pubkey))},reply(e){this.replyEvent=null,setTimeout((()=>{let s=Object.assign({},e);s.appended=[],this.replyEvent=s,this.$emit("reply-event",this.replyEvent)}),20)},updateCurrentDatestamp(e){let s=this.$refs.messageScroll,t=Array.from(s.querySelectorAll(".datestamp")),a=document.querySelector("#header").clientHeight,r=t.reduce(((e,s)=>{let t=s.getBoundingClientRect();return t.top<a&&s.offsetTop>e.offsetTop?s:e}),t[0]);this.currentDatestamp=r.innerText},delayedUpdateCurrentDatestamp(e){let s=0,t=setInterval((()=>{this.updateCurrentDatestamp(),s++,s>9&&clearInterval(t)}),100)},async addMessage(e){if(this.messagesSet.has(e.id))return;this.messagesSet.add(e.id),await this.lock(),e.text=await this.getPlaintext(e),this.unlock(),this.interpolateMessageMentions(e);let s=this.$refs.messageScroll,t=100>Math.abs(s.scrollHeight-s.clientHeight-s.scrollTop)||s.scrollHeight===s.clientHeight;if(0===this.messages.length)this.messages.push(e);else{let s=this.messages[this.messages.length-1];e.pubkey===this.$store.state.keys.pub&&s.pubkey===e.pubkey&&s.created_at+120>=e.created_at?(s.appended=s.appended||[],s.appended.push(e)):this.messages.push(e)}t?(this.$store.commit("haveReadMessage",this.$route.params.pubkey),this.scrollToBottom()):e.pubkey===this.$route.params.pubkey&&this.unreadMessagesSet.add(e.id)},resizeHeaderPlaceholder(){setTimeout((()=>{document.querySelector("#header-placeholder").style.minHeight=`${document.querySelector("#header").clientHeight}px`}),1e3)}}};var $=t(11639),S=t(69885),x=t(50926),q=t(86870),_=t(10786),C=t(24455),T=t(27350),D=t(69984),z=t.n(D);const H=(0,$.Z)(w,[["render",k],["__scopeId","data-v-ad383cf6"]]),B=H;z()(w,"components",{QPage:S.Z,QSeparator:x.Z,QInfiniteScroll:q.Z,QSpinnerOrbit:_.Z,QBtn:C.Z}),z()(w,"directives",{ScrollFire:T.Z})}}]);