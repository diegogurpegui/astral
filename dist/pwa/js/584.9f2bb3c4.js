"use strict";(globalThis["webpackChunkastral"]=globalThis["webpackChunkastral"]||[]).push([[584],{61770:(e,s,t)=>{t.r(s),t.d(s,{default:()=>V});var a=t(59835),l=t(61957),o=t(86970);const n={id:"profile-header"},r={key:1},i={key:2},d={key:0},u={key:1,class:"flex column relative"},h={class:"q-pl-sm"},c={key:0},p={key:1,class:"flex column relative"},m={class:"q-pl-sm"},b={key:0},w={key:1,class:"flex column relative"},g={class:"q-pl-sm"};function f(e,s,t,f,y,k){const v=(0,a.up)("BaseUserCard"),U=(0,a.up)("q-tab"),E=(0,a.up)("q-tabs"),_=(0,a.up)("BaseButtonClear"),x=(0,a.up)("q-btn"),T=(0,a.up)("q-input"),$=(0,a.up)("q-form"),q=(0,a.up)("BasePostThread"),S=(0,a.up)("BaseButtonLoadMore"),D=(0,a.up)("q-tab-panel"),M=(0,a.up)("BaseRelayRecommend"),Z=(0,a.up)("q-tab-panels"),W=(0,a.up)("q-page");return(0,a.wg)(),(0,a.j4)(W,null,{default:(0,a.w5)((()=>[(0,a._)("div",n,[e.$route.params.pubkey?((0,a.wg)(),(0,a.j4)(v,{key:0,pubkey:e.$route.params.pubkey,class:"user-card-header q-ma-sm","header-mode":!0,"show-following":!0,clickable:!1},null,8,["pubkey"])):(0,a.kq)("",!0)]),(0,a.Wm)(E,{modelValue:e.tab,"onUpdate:modelValue":s[0]||(s[0]=s=>e.tab=s),dense:"",outline:"",align:"left","active-color":"accent",breakpoint:0},{default:(0,a.w5)((()=>[(0,a.Wm)(U,{name:"posts",label:"posts"}),(0,a.Wm)(U,{name:"follows",label:"follows"}),(0,a.Wm)(U,{name:"followers",label:"followers"}),(0,a.Wm)(U,{name:"relays",label:"relays"})])),_:1},8,["modelValue"]),(0,a.Wm)(Z,{modelValue:e.tab,"onUpdate:modelValue":s[4]||(s[4]=s=>e.tab=s),animated:""},{default:(0,a.w5)((()=>[(0,a.Wm)(D,{name:"posts",class:"no-padding"},{default:(0,a.w5)((()=>[e.threads.length?((0,a.wg)(),(0,a.j4)($,{key:0,class:"q-pa-sm",onSubmit:e.search},{default:(0,a.w5)((()=>[(0,a.Wm)(T,{modelValue:e.searchText,"onUpdate:modelValue":s[2]||(s[2]=s=>e.searchText=s),outlined:"",rounded:"",label:e.$t("searchPosts"),dense:"",color:"secondary",class:"no-padding",loading:e.searching,onClear:s[3]||(s[3]=(0,l.iM)((s=>e.searchText=""),["stop"])),onSubmit:e.search,onKeypress:(0,l.D2)((0,l.iM)(e.search,["ctrl"]),["enter"])},{append:(0,a.w5)((()=>[(0,a.Wm)(_,{"button-text":e.searchText,"button-class":"text-secondary",onClear:s[1]||(s[1]=s=>e.searchText="")},null,8,["button-text"]),(0,a.Wm)(x,{"text-color":"secondary",class:"q-pa-xs",icon:"search",type:"submit",unelevated:"",disable:e.searching,onClick:e.search},null,8,["disable","onClick"])])),_:1},8,["modelValue","label","loading","onSubmit","onKeypress"])])),_:1},8,["onSubmit"])):(0,a.kq)("",!0),e.results.length?((0,a.wg)(),(0,a.iD)("div",r,[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(e.results,(s=>((0,a.wg)(),(0,a.j4)(q,{key:s[0].id,events:s,onAddEvent:e.addEvent},null,8,["events","onAddEvent"])))),128))])):(0,a.kq)("",!0),e.searchText?(0,a.kq)("",!0):((0,a.wg)(),(0,a.iD)("div",i,[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(e.threads,(s=>((0,a.wg)(),(0,a.j4)(q,{key:s[0].id,events:s,onAddEvent:e.addEvent},null,8,["events","onAddEvent"])))),128)),(0,a.Wm)(S,{"loading-more":e.loadingMore,"reached-end":e.reachedEnd,onClick:e.loadMore},null,8,["loading-more","reached-end","onClick"])]))])),_:1}),(0,a.Wm)(D,{name:"follows",class:"no-padding"},{default:(0,a.w5)((()=>[e.follows?((0,a.wg)(),(0,a.iD)("div",u,[(0,a._)("div",h,[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(e.follows,(e=>((0,a.wg)(),(0,a.j4)(v,{key:e,pubkey:e,"show-following":!0},null,8,["pubkey"])))),128))])])):((0,a.wg)(),(0,a.iD)("div",d,(0,o.zw)(e.$t("noFollows")),1))])),_:1}),(0,a.Wm)(D,{name:"followers",class:"no-padding"},{default:(0,a.w5)((()=>[e.followers?((0,a.wg)(),(0,a.iD)("div",p,[(0,a._)("div",m,[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(Object.keys(e.followers),(e=>((0,a.wg)(),(0,a.j4)(v,{key:e,pubkey:e,"show-following":!0},null,8,["pubkey"])))),128))])])):((0,a.wg)(),(0,a.iD)("div",c,(0,o.zw)(e.$t("noFollowers")),1))])),_:1}),(0,a.Wm)(D,{name:"relays",class:"no-padding"},{default:(0,a.w5)((()=>[e.relays?((0,a.wg)(),(0,a.iD)("div",w,[(0,a._)("div",g,[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(Object.keys(e.relays),(e=>((0,a.wg)(),(0,a.j4)(M,{key:e,url:e,"list-view":!0},null,8,["url"])))),128))])])):((0,a.wg)(),(0,a.iD)("div",b,(0,o.zw)(e.$t("noRelays")),1))])),_:1})])),_:1},8,["modelValue"])])),_:1})}t(40702),t(18964);var y=t(60899),k=t(18933),v=t(14473),U=t(36345),E=t(34136),_=t(37139),x=t(80626),T=t(46973);const $=(0,a.aZ)({name:"Profile",mixins:[k.Z],components:{BaseUserCard:U.Z,BaseRelayRecommend:_.Z,BaseButtonLoadMore:x.Z,BaseButtonClear:T.Z},data(){return{threads:[],eventsSet:new Set,sub:{},tab:"posts",followsEvent:null,follows:[],followers:[],relays:{},profilesUsed:new Set,loadingMore:!0,reachedEnd:!1,searchText:"",searching:!1,results:[]}},activated(){this.start()},deactivated(){this.stop()},methods:{async start(){this.useProfile(this.$route.params.pubkey),this.loadingMore=!0;let e=setTimeout((async()=>{this.loadMore()}),4e3);this.sub.streamUserNotes=(0,E.pq)(this.$route.params.pubkey,(s=>{e||this.processUserNotes([s],this.threads),e&&clearTimeout(e),e=setTimeout((async()=>{this.loadMore(),clearTimeout(e),e=null}),500)})),this.sub.dbStreamUserFollows=(0,E.g2)(this.$route.params.pubkey,(e=>{this.followsEvent&&e.created_at<this.followsEvent.created_at||(this.followsEvent=e,this.follows=e.tags.filter((([e,s])=>"p"===e&&s)).map((([e,s])=>s)),this.relays=JSON.parse(e.content),this.follows.length&&this.follows.forEach((e=>this.useProfile(e))))})),this.sub.dbStreamUserFollowers=(0,E.E1)(this.$route.params.pubkey,(e=>{this.followers[e.pubkey]=!0,this.useProfile(e.pubkey)}))},stop(){this.sub.streamUserNotes&&this.sub.streamUserNotes.cancel(),this.sub.dbStreamUserFollows&&this.sub.dbStreamUserFollows.cancel(),this.sub.dbStreamUserFollowers&&this.sub.dbStreamUserFollowers.cancel(),this.profilesUsed.forEach((e=>this.$store.dispatch("cancelUseProfile",{pubkey:e})))},processUserNotes(e,s){for(let t of e)this.eventsSet.has(t.id)||(this.interpolateEventMentions(t),this.eventsSet.add(t.id),(0,v.c)(s,t))},useProfile(e){this.profilesUsed.has(e)||(this.profilesUsed.add(e),this.$store.dispatch("useProfile",{pubkey:e}))},addEvent(e){this.processUserNotes([e],this.threads)},async loadMore(){this.loadingMore=!0;let e=this.threads.length?this.threads[this.threads.length-1][0].created_at:Math.round(Date.now()/1e3),s=await(0,E.sM)(this.$route.params.pubkey,e,50);s.length<50&&(this.reachedEnd=!0);let t=[];this.processUserNotes(s,t),this.threads=this.threads.concat(t),this.loadingMore=!1},async search(){this.searching=!0,this.results=[];let e=await(0,E.$d)(`\n        SELECT event\n        FROM nostr\n        WHERE json_extract(event,'$.kind') = 1 AND\n          json_extract(event,'$.pubkey') = '${this.$route.params.pubkey}' AND\n          json_extract(event,'$.content') LIKE '%${this.searchText.replace(" ","%")}%'\n      `),s=e.map((e=>JSON.parse(e.event)));this.processUserNotes(s,this.results),this.searching=!1,console.log("result ",s)},debouncedSearch(){(0,y.Z)(this.search(),1e3),console.log("debounced search")}}});var q=t(11639),S=t(69885),D=t(47817),M=t(70900),Z=t(89800),W=t(84106),B=t(8326),j=t(66611),C=t(24455),N=t(69984),P=t.n(N);const F=(0,q.Z)($,[["render",f],["__scopeId","data-v-0f60f1a4"]]),V=F;P()($,"components",{QPage:S.Z,QTabs:D.Z,QTab:M.Z,QTabPanels:Z.Z,QTabPanel:W.Z,QForm:B.Z,QInput:j.Z,QBtn:C.Z})}}]);